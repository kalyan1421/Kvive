rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================================
    // ðŸ”§ Helper Functions
    // =====================================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid));
    }
    
    function isTokenAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // =====================================================
    // ðŸ”¹ 1. Public Sticker Packs (Read-Only)
    // =====================================================
    match /sticker_packs/{packId} {
      allow read: if true; // Anyone can read
      // Write only by admin (via custom token)
      allow write, update, delete: if isTokenAdmin();
      
      // Subcollection: stickers
      match /stickers/{stickerId} {
        allow read: if true;
        allow write, update, delete: if isTokenAdmin();
      }
    }
    
    // =====================================================
    // ðŸ”¹ 2. User Data (Private)
    // =====================================================
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
      
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }
    
    // =====================================================
    // ðŸ”¹ 3. Keyboard Settings (User Private)
    // =====================================================
    match /users/{uid}/settings/keyboard {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    
    // =====================================================
    // ðŸ”¹ 4. User Dictionary (Personal Dictionary)
    // =====================================================
    match /users/{uid}/dictionary/{locale} {
      allow read, write, list: if request.auth != null && request.auth.uid == uid;
    }
    
    // =====================================================
    // ðŸ”¹ 5. Shared Word Frequency (Read-Only to Users)
    // =====================================================
    match /dictionary_frequency/{language} {
      allow read: if request.auth != null;
      allow write: if isTokenAdmin(); // Model data must be protected
    }
    
    // =====================================================
    // ðŸ”¹ 6. Devices (Push Notification Tokens)
    // =====================================================
    match /devices/{deviceToken} {
      // Anyone can write their own token (no auth required for initial registration)
      allow create: if true;
      // Allow devices to update their own token
      allow update: if true;
      // Admins can read/write all tokens
      allow read, write: if isAdmin();
    }
    
    // =====================================================
    // ðŸ”¹ 7. User Sessions (For Analytics / Session Tracking)
    // =====================================================
    match /userSessions/{sessionId} {
      allow read, write: if isAdmin();
      // Users can create their own sessions
      allow create: if isAuthenticated();
    }
    
    // =====================================================
    // ðŸ”¹ 8. Broadcast Notifications (Admin Only)
    // =====================================================
    match /broadcastNotifications/{notificationId} {
      allow read, write: if isAdmin();
    }
    
    // =====================================================
    // ðŸ”¹ 9. User Notifications (Device-specific)
    // =====================================================
    match /userNotifications/{deviceToken} {
      // Allow devices to read/write their own notifications
      allow read, write: if true; // No auth required, identified by device token
      
      match /notifications/{notificationId} {
        allow read, write: if true;
        allow update: if true; // Mark as read
        allow delete: if true;
      }
    }
    
    // =====================================================
    // ðŸ”¹ 10. Admin Users Collection
    // =====================================================
    match /adminUsers/{adminId} {
      // Anyone authenticated can create their own admin document
      // App logic ensures only first admin is created manually
      allow create: if isAuthenticated() && request.auth.uid == adminId;
      // Anyone can read to check if admin collection is empty
      allow read: if true;
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }
    
    // =====================================================
    // ðŸ”¥ 11. Default Deny Rule (Security Fallback)
    // =====================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
